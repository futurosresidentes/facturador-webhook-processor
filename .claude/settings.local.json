{
  "permissions": {
    "allow": [
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfix: Corregir fechas de promoción Oct 2025 y configuración de memberships\n\nPROBLEMA ENCONTRADO:\n- Usuario compró \"Élite - 9 meses - Cuota 1\" el 20 Oct 2025\n- Solo recibió 1 membership (Élite 9 meses)\n- Debía recibir 3 (Élite + CES + UPB) por la promoción\n\nERRORES IDENTIFICADOS:\n\n1. FECHAS DE PROMOCIÓN INCORRECTAS:\n   ❌ Antes: 2024-10-01 a 2024-10-31 (año 2024!)\n   ✅ Ahora: 2025-10-14 a 2025-10-21 (año 2025)\n   \n   El webhook del 20 Oct 2025 NO coincidía con rango 2024,\n   por eso usaba configuración estándar (solo 1 membership)\n\n2. FECHAS FIJAS CES/UPB INCORRECTAS:\n   ❌ CES antes: 2025-11-21T04:59:59Z\n   ✅ CES ahora: 2025-11-20T23:59:59-05:00\n   \n   ❌ UPB antes: 2026-04-09T04:59:59Z\n   ✅ UPB ahora: 2026-04-08T23:59:59-05:00\n\n3. MEMBERSHIPPLANID INCORRECTO:\n   ❌ Élite 6 meses antes: planId 2\n   ✅ Élite 6 meses ahora: planId 4\n\n4. DURACIÓN DÍAS ESTÁNDAR INCORRECTA:\n   ❌ Élite 9 meses estándar: 370 días\n   ✅ Élite 9 meses estándar: 288 días\n   \n   ❌ Élite 6 meses estándar: 186 días\n   ✅ Élite 6 meses estándar: 188 días\n\nCAMBIOS EN promotions.js:\n\nPROMOCIÓN OCT 2025:\n- Renombrar: promo_octubre_2024 → promocion_oct_2025\n- Fechas: 14-21 Oct 2025 (timezone -05:00)\n- Élite 6 meses: planId 4, 288 días\n- Élite 9 meses: planId 3, 370 días (correcto en promo)\n- CES: planId 9, fin 2025-11-20\n- UPB: planId 10, fin 2026-04-08\n\nCONFIGURACIÓN ESTÁNDAR:\n- Élite 6 meses: planId 4, 188 días\n- Élite 9 meses: planId 3, 288 días\n\nRESULTADO ESPERADO:\nAhora cuando llegue un webhook de \"Élite - 9 meses - Cuota 1\"\nentre el 14-21 Oct 2025, recibirá:\n\n1. Élite 9 meses (370 días desde hoy)\n2. Simulación CES (hasta 2025-11-20)\n3. Simulación UPB (hasta 2026-04-08)\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git push:*)",
      "Bash(node test-webhook.js:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat: Refactorizar flujo de membresías y CRM + agregar etiquetas y activationUrl\n\nOPTIMIZACIÓN DEL FLUJO:\n=====================================\nANTES:\n1. FR360 → 2. CRM → 3. Membresías → 4. World Office\nProblema: Necesitábamos 2 llamados al CRM (crear + actualizar activationUrl)\n\nAHORA:\n1. FR360 → 2. Membresías → 3. CRM (con activationUrl + etiquetas) → 4. World Office\n✅ Un solo llamado al CRM con TODOS los datos\n\nCONSOLIDACIÓN DE SERVICIOS CRM:\n=====================================\n- ❌ Eliminado: crmService.js (versión simple)\n- ✅ Renombrado: crmService.v2.js → crmService.js\n- ➕ Agregado: addTagToContact(contactId, tagId)\n- 🔧 Modificado: updateContact() acepta activationUrl (campo 303)\n\nCORRECCIÓN PAYLOAD DE MEMBERSHIPS:\n=====================================\nANTES (incorrecto):\n- Siempre pasaba membershipDurationDays (incluso para fechas fijas)\n\nAHORA (correcto):\n- Si usarFechaInicio=true → pasa membershipDurationDays\n- Si usarFechaInicio=false → pasa membershipEndDate (NO duration)\n- Agrega flags createMembershipIfUserExists y allowDuplicateMemberships para 2da+ membership\n\nCAMBIOS EN promotions.js:\n- membershipExpiryDate → fechaFinFija (consistencia con Apps Script)\n- Usar new Date() en lugar de strings\n\nCAMBIOS EN membershipService.js:\n- Agregar constantes ETIQUETAS_POR_PLAN y ETIQUETA_NUEVA_PLATAFORMA\n- Corregir payload según usarFechaInicio\n- Cambiar retorno: { activationUrl, etiquetas, membreshipsCreadas }\n- Mejorar notificación: mostrar \"Duración\" vs \"Fecha fin fija\"\n\nCAMBIOS EN webhookProcessor.js:\n- Import Contact model\n- NUEVO PASO 3: Crear membresías PRIMERO\n- NUEVO PASO 4: Crear/actualizar CRM + activationUrl + etiquetas\n- Paso 5: World Office (antes era paso 6)\n- Usar crmService.createOrUpdateContact() (en vez de findOrCreateContact)\n- Aplicar etiquetas solo cuando se crean membersías\n\nFLUJO OPTIMIZADO FINAL:\n=====================================\n0. Webhook recibido\n1. Extracción Invoice ID\n2. Consulta FR360\n3. Creación de membresías → obtiene { activationUrl, etiquetas }\n4. Gestión CRM → un llamado con TODO (datos + activationUrl + etiquetas)\n5. Gestión World Office\n\nETIQUETAS APLICADAS (solo con memberships):\n- 1172: Nueva plataforma (siempre)\n- 1174: Élite 6 meses (planId 4)\n- 1175: Élite 9 meses (planId 3)\n- 1176: Élite 12 meses (planId 1)\n\nNOTIFICACIÓN MEJORADA PASO 3:\nMembresías: \n1. Élite 9 meses (Plan ID: 3)\n   • Inicia: 2025-10-21\n   • Duración: 370 días\n\n2. Simulación CES (Plan ID: 9)\n   • Inicia: 2025-10-21\n   • Fecha fin fija: 2025-11-20T23:59:59 ← Ahora distingue\n\n3. Simulación UPB (Plan ID: 10)\n   • Inicia: 2025-10-21\n   • Fecha fin fija: 2026-04-08T23:59:59\n\nNOTIFICACIÓN MEJORADA PASO 4:\n• Acción: 🆕 Contacto creado (o 🔄 actualizado)\n• CRM ID: 12345\n• ActivationUrl: ✅ Actualizada\n• Etiquetas aplicadas: 2 (1172, 1175)\n\nRESULTADO:\n✅ Código más limpio y eficiente\n✅ Un solo archivo CRM (no duplicados)\n✅ Flujo optimizado (menos llamados API)\n✅ Etiquetas aplicadas automáticamente\n✅ ActivationUrl actualizada en CRM\n✅ Payload correcto para fechas fijas\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")"
    ],
    "deny": [],
    "ask": []
  }
}
