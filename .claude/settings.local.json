{
  "permissions": {
    "allow": [
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfix: Corregir fechas de promociÃ³n Oct 2025 y configuraciÃ³n de memberships\n\nPROBLEMA ENCONTRADO:\n- Usuario comprÃ³ \"Ã‰lite - 9 meses - Cuota 1\" el 20 Oct 2025\n- Solo recibiÃ³ 1 membership (Ã‰lite 9 meses)\n- DebÃ­a recibir 3 (Ã‰lite + CES + UPB) por la promociÃ³n\n\nERRORES IDENTIFICADOS:\n\n1. FECHAS DE PROMOCIÃ“N INCORRECTAS:\n   âŒ Antes: 2024-10-01 a 2024-10-31 (aÃ±o 2024!)\n   âœ… Ahora: 2025-10-14 a 2025-10-21 (aÃ±o 2025)\n   \n   El webhook del 20 Oct 2025 NO coincidÃ­a con rango 2024,\n   por eso usaba configuraciÃ³n estÃ¡ndar (solo 1 membership)\n\n2. FECHAS FIJAS CES/UPB INCORRECTAS:\n   âŒ CES antes: 2025-11-21T04:59:59Z\n   âœ… CES ahora: 2025-11-20T23:59:59-05:00\n   \n   âŒ UPB antes: 2026-04-09T04:59:59Z\n   âœ… UPB ahora: 2026-04-08T23:59:59-05:00\n\n3. MEMBERSHIPPLANID INCORRECTO:\n   âŒ Ã‰lite 6 meses antes: planId 2\n   âœ… Ã‰lite 6 meses ahora: planId 4\n\n4. DURACIÃ“N DÃAS ESTÃNDAR INCORRECTA:\n   âŒ Ã‰lite 9 meses estÃ¡ndar: 370 dÃ­as\n   âœ… Ã‰lite 9 meses estÃ¡ndar: 288 dÃ­as\n   \n   âŒ Ã‰lite 6 meses estÃ¡ndar: 186 dÃ­as\n   âœ… Ã‰lite 6 meses estÃ¡ndar: 188 dÃ­as\n\nCAMBIOS EN promotions.js:\n\nPROMOCIÃ“N OCT 2025:\n- Renombrar: promo_octubre_2024 â†’ promocion_oct_2025\n- Fechas: 14-21 Oct 2025 (timezone -05:00)\n- Ã‰lite 6 meses: planId 4, 288 dÃ­as\n- Ã‰lite 9 meses: planId 3, 370 dÃ­as (correcto en promo)\n- CES: planId 9, fin 2025-11-20\n- UPB: planId 10, fin 2026-04-08\n\nCONFIGURACIÃ“N ESTÃNDAR:\n- Ã‰lite 6 meses: planId 4, 188 dÃ­as\n- Ã‰lite 9 meses: planId 3, 288 dÃ­as\n\nRESULTADO ESPERADO:\nAhora cuando llegue un webhook de \"Ã‰lite - 9 meses - Cuota 1\"\nentre el 14-21 Oct 2025, recibirÃ¡:\n\n1. Ã‰lite 9 meses (370 dÃ­as desde hoy)\n2. SimulaciÃ³n CES (hasta 2025-11-20)\n3. SimulaciÃ³n UPB (hasta 2026-04-08)\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git push:*)",
      "Bash(node test-webhook.js:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat: Refactorizar flujo de membresÃ­as y CRM + agregar etiquetas y activationUrl\n\nOPTIMIZACIÃ“N DEL FLUJO:\n=====================================\nANTES:\n1. FR360 â†’ 2. CRM â†’ 3. MembresÃ­as â†’ 4. World Office\nProblema: NecesitÃ¡bamos 2 llamados al CRM (crear + actualizar activationUrl)\n\nAHORA:\n1. FR360 â†’ 2. MembresÃ­as â†’ 3. CRM (con activationUrl + etiquetas) â†’ 4. World Office\nâœ… Un solo llamado al CRM con TODOS los datos\n\nCONSOLIDACIÃ“N DE SERVICIOS CRM:\n=====================================\n- âŒ Eliminado: crmService.js (versiÃ³n simple)\n- âœ… Renombrado: crmService.v2.js â†’ crmService.js\n- âž• Agregado: addTagToContact(contactId, tagId)\n- ðŸ”§ Modificado: updateContact() acepta activationUrl (campo 303)\n\nCORRECCIÃ“N PAYLOAD DE MEMBERSHIPS:\n=====================================\nANTES (incorrecto):\n- Siempre pasaba membershipDurationDays (incluso para fechas fijas)\n\nAHORA (correcto):\n- Si usarFechaInicio=true â†’ pasa membershipDurationDays\n- Si usarFechaInicio=false â†’ pasa membershipEndDate (NO duration)\n- Agrega flags createMembershipIfUserExists y allowDuplicateMemberships para 2da+ membership\n\nCAMBIOS EN promotions.js:\n- membershipExpiryDate â†’ fechaFinFija (consistencia con Apps Script)\n- Usar new Date() en lugar de strings\n\nCAMBIOS EN membershipService.js:\n- Agregar constantes ETIQUETAS_POR_PLAN y ETIQUETA_NUEVA_PLATAFORMA\n- Corregir payload segÃºn usarFechaInicio\n- Cambiar retorno: { activationUrl, etiquetas, membreshipsCreadas }\n- Mejorar notificaciÃ³n: mostrar \"DuraciÃ³n\" vs \"Fecha fin fija\"\n\nCAMBIOS EN webhookProcessor.js:\n- Import Contact model\n- NUEVO PASO 3: Crear membresÃ­as PRIMERO\n- NUEVO PASO 4: Crear/actualizar CRM + activationUrl + etiquetas\n- Paso 5: World Office (antes era paso 6)\n- Usar crmService.createOrUpdateContact() (en vez de findOrCreateContact)\n- Aplicar etiquetas solo cuando se crean membersÃ­as\n\nFLUJO OPTIMIZADO FINAL:\n=====================================\n0. Webhook recibido\n1. ExtracciÃ³n Invoice ID\n2. Consulta FR360\n3. CreaciÃ³n de membresÃ­as â†’ obtiene { activationUrl, etiquetas }\n4. GestiÃ³n CRM â†’ un llamado con TODO (datos + activationUrl + etiquetas)\n5. GestiÃ³n World Office\n\nETIQUETAS APLICADAS (solo con memberships):\n- 1172: Nueva plataforma (siempre)\n- 1174: Ã‰lite 6 meses (planId 4)\n- 1175: Ã‰lite 9 meses (planId 3)\n- 1176: Ã‰lite 12 meses (planId 1)\n\nNOTIFICACIÃ“N MEJORADA PASO 3:\nMembresÃ­as: \n1. Ã‰lite 9 meses (Plan ID: 3)\n   â€¢ Inicia: 2025-10-21\n   â€¢ DuraciÃ³n: 370 dÃ­as\n\n2. SimulaciÃ³n CES (Plan ID: 9)\n   â€¢ Inicia: 2025-10-21\n   â€¢ Fecha fin fija: 2025-11-20T23:59:59 â† Ahora distingue\n\n3. SimulaciÃ³n UPB (Plan ID: 10)\n   â€¢ Inicia: 2025-10-21\n   â€¢ Fecha fin fija: 2026-04-08T23:59:59\n\nNOTIFICACIÃ“N MEJORADA PASO 4:\nâ€¢ AcciÃ³n: ðŸ†• Contacto creado (o ðŸ”„ actualizado)\nâ€¢ CRM ID: 12345\nâ€¢ ActivationUrl: âœ… Actualizada\nâ€¢ Etiquetas aplicadas: 2 (1172, 1175)\n\nRESULTADO:\nâœ… CÃ³digo mÃ¡s limpio y eficiente\nâœ… Un solo archivo CRM (no duplicados)\nâœ… Flujo optimizado (menos llamados API)\nâœ… Etiquetas aplicadas automÃ¡ticamente\nâœ… ActivationUrl actualizada en CRM\nâœ… Payload correcto para fechas fijas\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")"
    ],
    "deny": [],
    "ask": []
  }
}
